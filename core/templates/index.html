{% extends 'base.html' %}

{% block title %}Lista de Funcion치rios{% endblock %}

{% block content %}

{% load static %}

{% csrf_token %}

{% load form_tags %}

<div class="container mt-3 px-0 ">
    <div class="no-print mb-3">
        <form method="get" class="d-flex flex-wrap align-items-center justify-content-between w-100">

            <div class="d-flex flex-wrap align-items-center gap-2">
                <!-- Quantidade -->
                <input type="number" name="quantidade" min="1" class="form-control input-quantidade"
                    value="{{ request.GET.quantidade }}" oninput="this.form.submit()">

                <!-- Pesquisa -->
                <input id="searchInput" type="search" name="search" class="form-control input-pesquisa"
                    placeholder="Pesquisar..." value="{{ request.GET.search }}">
            </div>

            <div>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#funcionarioModal"
                    onclick="setCreateMode()">
                    <i class="bi bi-person-plus"></i> Novo funcion치rio
                </button>
            </div>

        </form>
    </div>

    <div id="content-to-print">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th scope="col" class="matricula-col">Matr칤cula</th>
                    <th scope="col">Nome</th>
                    <th scope="col">Fun칞칚o</th>
                    <th scope="col">Status</th>
                    <th scope="col">Obra</th>
                    <th class="no-print"></th>
                </tr>
            </thead>
            <tbody>
                {% for funcionario in funcionarios %}
                <tr>
                    <td class="matricula-col">{{ funcionario.matricula }}</td>
                    <td>{{ funcionario.nome }}</td>
                    <td>{{ funcionario.funcao }}</td>
                    <td>{{ funcionario.get_status_display }}</td>
                    <td>{{ funcionario.obra }}</td>
                    <td class="text-center no-print">
                        <!-- Visualizar -->
                        <button type="button" class="btn btn-sm btn-info text-white" style="background-color: #78b7ff;"
                            data-bs-toggle="modal" data-bs-target="#viewModal{{ funcionario.matricula }}">
                            <i class="bi bi-eye text-muted"></i>
                        </button>

                        <!-- Editar -->
                        <button type="button" class="btn btn-warning text-white" data-bs-toggle="modal"
                            data-bs-target="#funcionarioModal" data-matricula="{{ funcionario.matricula }}"
                            data-data-nascimento="{{ funcionario.data_nascimento|date:'Y-m-d' }}"
                            data-nome="{{ funcionario.nome }}" data-cpf="{{ funcionario.cpf }}"
                            data-funcao="{{ funcionario.funcao }}" data-nivel_funcao="{{ funcionario.nivel_funcao }}"
                            data-status="{{ funcionario.status }}" data-obra="{{ funcionario.obra }}"
                            data-data_admissao="{{ funcionario.data_admissao|date:'Y-m-d' }}"
                            data-cep="{{ funcionario.cep }}" data-logradouro="{{ funcionario.logradouro }}"
                            data-bairro="{{ funcionario.bairro }}" data-cidade="{{ funcionario.cidade }}"
                            data-uf="{{ funcionario.uf }}" data-numero="{{ funcionario.numero }}"
                            data-complemento="{{ funcionario.complemento }}" {%if funcionario.foto %}
                            data-foto-url="{{ funcionario.foto.url }}" {% else %} data-foto-url="" {% endif %}
                            data-ordem-servico-existe="{% if funcionario.ordem_servico %}true{% else %}false{% endif %}"
                            data-contrato-trabalho-existe="{% if funcionario.contrato_trabalho %}true{% else %}false{% endif %}"
                            onclick="handleEditClick(this)">
                            <i class="bi bi-pencil text-muted"></i>
                        </button>

                        <!-- Deletar -->
                        <button type="button" class="btn btn-sm btn-danger text-white"
                            style="background-color: #ff5555;" data-bs-toggle="modal"
                            data-bs-target="#deleteModal{{ funcionario.matricula }}">
                            <i class="bi bi-trash text-muted"></i>
                        </button>
                    </td>

                    <!-- Modal de Visualizar -->
                    <div class="modal fade" id="viewModal{{ funcionario.matricula }}" tabindex="-1"
                        aria-labelledby="viewModalLabel{{ funcionario.matricula }}" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header" style="background-color: #78b7ff; color: white;">
                                    <h5 class="modal-title" id="viewModalLabel{{ funcionario.matricula }}">
                                        Detalhes do Funcion치rio
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white"
                                        data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body"
                                    style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;">
                                    <!-- Informa칞칫es do funcion치rio -->
                                    <div style="flex: 1; min-width: 100px;">
                                        <p><strong>Matr칤cula:</strong> {{ funcionario.matricula|default:"N칚o
                                            informado"}}</p>
                                        <p><strong>Data de nascimento:</strong>
                                            {{funcionario.data_nascimento|date:"d/m/Y"|default:"N칚o informado" }}</p>
                                        <p><strong>Idade:</strong>
                                            {% if funcionario.idade %}
                                            {{ funcionario.idade }} anos
                                            {% else %}
                                            N칚o informado
                                            {% endif %}
                                        </p>
                                        <p><strong>Nome:</strong> {{ funcionario.nome|default:"N칚o informado" }}</p>
                                        <p><strong>CPF:</strong>
                                            {% if funcionario.cpf %}
                                            <span data-format-cpf>{{ funcionario.cpf }}</span>
                                            {% else %}
                                            N칚o informado
                                            {% endif %}
                                        </p>
                                        <p><strong>Fun칞칚o:</strong> {{ funcionario.funcao|default:"N칚o informado" }}</p>
                                        <p><strong>N칤vel da fun칞칚o:</strong> {{ funcionario.nivel_funcao|default:"N칚o
                                            informado" }}</p>
                                        <p><strong>Status:</strong> {{ funcionario.get_status_display|default:"N칚o
                                            informado" }}</p>
                                        <p><strong>Obra:</strong> {{ funcionario.obra|default:"N칚o informado" }}</p>
                                        {% if funcionario.data_admissao %}
                                        <p><strong>Data de Admiss칚o:</strong> {{funcionario.data_admissao|date:"d/m/Y"}}
                                        </p>
                                        {% else %}
                                        <p><strong>Data de Admiss칚o:</strong> N칚o informada</p>
                                        {% endif %}
                                    </div>

                                    <!-- Coluna 2 -->
                                    <div style="flex: 1; min-width: 100px;">
                                        <p><strong>CEP:</strong> {{ funcionario.cep|default:"N칚o informado" }}</p>
                                        <p><strong>Logradouro:</strong> {{ funcionario.logradouro|default:"N칚o
                                            informado" }}</p>
                                        <p><strong>N칰mero:</strong> {{ funcionario.numero|default:"N칚o informado" }}</p>
                                        <p><strong>Complemento:</strong> {{ funcionario.complemento|default:"N칚o
                                            informado" }}</p>
                                        <p><strong>Bairro:</strong> {{ funcionario.bairro|default:"N칚o informado" }}</p>
                                        <p><strong>Cidade:</strong> {{ funcionario.cidade|default:"N칚o informado" }}</p>
                                        <p><strong>UF:</strong> {{ funcionario.uf|default:"N칚o informado" }}</p>
                                    </div>

                                    <!-- Coluna 3 -->
                                    <div style="flex: 1; min-width: 100px;">
                                        <p><strong>Ordem de Servi칞o:</strong>
                                            {% if funcionario.ordem_servico %}
                                            <a href="{{ funcionario.ordem_servico.url }}" target="_blank">
                                                <i class="bi bi-eye" style="font-size: 1.5rem;"></i>
                                            </a>
                                            {% else %}
                                            N칚o informado
                                            {% endif %}
                                        </p>
                                        <p><strong>Contrato de Trabalho:</strong>
                                            {% if funcionario.contrato_trabalho %}
                                            <a href="{{ funcionario.contrato_trabalho.url }}" target="_blank">
                                                <i class="bi bi-eye" style="font-size: 1.5rem;"></i>
                                            </a>
                                            {% else %}
                                            N칚o informado
                                            {% endif %}
                                        </p>
                                    </div>


                                    <!-- Foto do funcion치rio com ajuste -->
                                    <div style="flex: 0 0 150px; margin-right: 30px; margin-top: 10px;">
                                        {% if funcionario.foto %}
                                        <img src="{{ funcionario.foto.url }}" alt="Foto de {{ funcionario.nome }}"
                                            class="img-fluid rounded"
                                            style="width: 150px; height: 200px; object-fit: cover;">
                                        {% else %}
                                        <img src="{% static 'img/sem-foto.png' %}" alt="Sem foto"
                                            class="img-fluid rounded"
                                            style="width: 150px; height: 200px; object-fit: cover;">
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal de Dele칞칚o (dentro do for) -->
                    <div class="modal fade" id="deleteModal{{ funcionario.matricula }}" tabindex="-1"
                        aria-labelledby="deleteModalLabel{{ funcionario.matricula }}" aria-hidden="true">
                        <div class="modal-dialog modal-md">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title" id="deleteModalLabel{{ funcionario.matricula }}">Confirmar
                                        Exclus칚o</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Fechar"></button>
                                </div>
                                <div class="modal-body">
                                    Tem certeza que deseja excluir o funcion치rio <strong>{{ funcionario.nome}}</strong>?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancelar</button>
                                    <a href="{% url 'delete' funcionario.matricula %}"
                                        class="btn btn-danger">Excluir</a>
                                </div>
                            </div>
                        </div>
                    </div>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">Nenhum funcion치rio cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<form method="post" id="funcionarioForm" enctype="multipart/form-data" autocomplete="off">
    <div class="modal fade" id="funcionarioModal" tabindex="-1" aria-labelledby="funcionarioModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="post" id="funcionarioForm">
                    {% csrf_token %}
                    <div class="modal-header bg-success text-white py-1">
                        <h5 class="modal-title" id="funcionarioModalLabel">Cadastrar Funcion치rio</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            <div class="row">
                                <!-- Coluna 1 -->
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-6 mb-1">
                                            <label for="id_matricula" class="form-label">Matr칤cula</label>
                                            {{ form.matricula }}
                                            {% if form.matricula.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.matricula.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="col-md-6 mb-1">
                                            <label for="id_data_nascimento" class="form-label">Data de
                                                Nascimento</label>
                                            {{ form.data_nascimento }}
                                            {% if form.data_nascimento.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.data_nascimento.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="mb-1">
                                        <label for="id_nome" class="form-label">Nome</label>
                                        {{ form.nome }}
                                    </div>

                                    <div class="mb-1">
                                        <label for="id_funcao" class="form-label">Fun칞칚o</label>
                                        {{ form.funcao }}
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-1">
                                            <label for="id_cpf" class="form-label">CPF</label>
                                            {{ form.cpf }}
                                            {% if form.cpf.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.cpf.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="col-md-6 mb-1">
                                            <label for="id_nivel_funcao" class="form-label">N칤vel da Fun칞칚o</label>
                                            {{ form.nivel_funcao }}
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-1">
                                            <label for="id_status" class="form-label">Status</label>
                                            {{ form.status }}
                                        </div>

                                        <div class="col-md-6 mb-1">
                                            <label for="id_obra" class="form-label">Obra</label>
                                            {{ form.obra }}
                                        </div>
                                    </div>

                                    <div class="row">
                                        <!-- Foto -->
                                        <div class="col-md-6 mb-1">
                                            <label class="form-label d-block">Foto</label>

                                            <div class="d-flex align-items-center gap-3">
                                                <!-- 칈cone de c칙mera (clic치vel) -->
                                                <label for="id_foto" style="cursor: pointer;">
                                                    <img id="icon-camera" src="{% static 'img/camera.png' %}"
                                                        alt="칈cone de c칙mera" style="height: 40px;">
                                                </label>

                                                <!-- Miniatura da imagem -->
                                                {% if funcionario and funcionario.foto %}
                                                <img id="preview-foto" src="{{ funcionario.foto.url }}"
                                                    alt="Pr칠-visualiza칞칚o da foto" class="border rounded"
                                                    style="height: 40px; display: inline-block;">
                                                {% else %}
                                                <img id="preview-foto" src="" alt="Pr칠-visualiza칞칚o da foto"
                                                    class="border rounded" style="height: 60px; display: none;">
                                                {% endif %}
                                            </div>

                                            <!-- Campo oculto do upload -->
                                            {{ form.foto|add_class:"d-none" }}
                                        </div>

                                        <!-- Data de Admiss칚o -->
                                        <div class="col-md-6 mb-1">
                                            <label for="id_data_admissao" class="form-label">Data de
                                                Admiss칚o</label>
                                            {{ form.data_admissao }}
                                            {% if form.data_admissao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.data_admissao.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="row">
                                        <!-- Ordem de Servi칞o -->
                                        <div class="col-md-6 mb-1">
                                            <label class="form-label d-block" for="id_ordem_servico">Ordem de
                                                Servi칞o</label>
                                            <label for="id_ordem_servico" style="cursor: pointer;">
                                                {% if funcionario.ordem_servico %}
                                                <img id="icon-ordem-servico" src="{% static 'img/box_fechado.png' %}"
                                                    alt="Ba칰 fechado" style="height: 40px;">
                                                {% else %}
                                                <img id="icon-ordem-servico" src="{% static 'img/box_aberto.png' %}"
                                                    alt="Ba칰 aberto" style="height: 40px;">
                                                {% endif %}
                                            </label>
                                            {{ form.ordem_servico|add_class:"d-none" }}
                                            {% if form.ordem_servico.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.ordem_servico.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Contrato de Trabalho -->
                                        <div class="col-md-6 mb-1">
                                            <label class="form-label d-block" for="id_contrato_trabalho">Contrato de
                                                Trabalho</label>
                                            <label for="id_contrato_trabalho" style="cursor: pointer;">
                                                {% if funcionario.contrato_trabalho %}
                                                <img id="icon-contrato-trabalho"
                                                    src="{% static 'img/box_fechado.png' %}" alt="Ba칰 fechado"
                                                    style="height: 40px;">
                                                {% else %}
                                                <img id="icon-contrato-trabalho" src="{% static 'img/box_aberto.png' %}"
                                                    alt="Ba칰 aberto" style="height: 40px;">
                                                {% endif %}
                                            </label>
                                            {{ form.contrato_trabalho|add_class:"d-none" }}
                                            {% if form.contrato_trabalho.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.contrato_trabalho.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Coluna 2 -->
                                <div class="col-md-6">
                                    <div class="mb-1">
                                        <label for="id_cep" class="form-label">CEP</label>
                                        <input type="text"
                                            class="form-control{% if form.errors.cep %} is-invalid{% endif %}"
                                            id="id_cep" name="cep" maxlength="9" required
                                            value="{{ form.data.cep|default_if_none:'' }}">
                                        <div class="invalid-feedback" id="cep-error" style="display: none;">CEP
                                            inv치lido ou n칚o encontrado.</div>
                                    </div>

                                    <div class="mb-1">
                                        <label for="{{ form.logradouro.id_for_label }}"
                                            class="form-label">Logradouro</label>
                                        {{ form.logradouro }}
                                        {% if form.logradouro.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.logradouro.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-1">
                                        <label for="{{ form.bairro.id_for_label }}" class="form-label">Bairro</label>
                                        {{ form.bairro }}
                                        {% if form.bairro.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.bairro.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-1">
                                        <label for="{{ form.cidade.id_for_label }}" class="form-label">Cidade</label>
                                        {{ form.cidade }}
                                        {% if form.cidade.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.cidade.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-1">
                                        <label for="{{ form.uf.id_for_label }}" class="form-label">Estado
                                            (UF)</label>
                                        {{ form.uf }}
                                        {% if form.uf.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.uf.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-1">
                                        <label for="id_numero" class="form-label">N칰mero</label>
                                        {{ form.numero }}
                                    </div>

                                    <div class="mb-1">
                                        <label for="id_complemento" class="form-label">Complemento</label>
                                        {{ form.complemento }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</form>


<!-- Modal de Sucesso -->
<div class="modal fade" id="cadastroSucessoModal" tabindex="-1" aria-labelledby="cadastroSucessoLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-success text-center">
            <div class="modal-header bg-success text-white py-2 d-flex justify-content-center position-relative">
                <h6 class="modal-title w-100" id="cadastroSucessoLabel">Sucesso!</h6>
                <button type="button" class="btn-close btn-close-white position-absolute end-0 me-2"
                    data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Funcion치rio cadastrado com sucesso!
            </div>
        </div>
    </div>
</div>

<a href="#" id="btn-cadastrar-usuario" title="Cadastrar Usu치rio">
    <i class="bi bi-person-plus"></i>
</a>

<a href="#" id="print-pdf" title="Imprimir PDF">
    <i class="bi bi-printer"></i>
</a>

<div class="modal fade" id="modalCadastrarUsuario" tabindex="-1" aria-labelledby="modalCadastrarUsuarioLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formCadastrarUsuario" novalidate>
                <div class="modal-header bg-success text-white py-1">
                    <h5 class="modal-title" id="modalCadastrarUsuarioLabel">Cadastrar Usu치rio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cpf" class="form-label">CPF</label>
                        <input type="text" class="form-control" id="cpf" required maxlength="14"
                            placeholder="000.000.000-00">
                        <div class="invalid-feedback">CPF inv치lido.</div>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Usu치rio</label>
                        <input type="text" class="form-control" id="username" required>
                        <div class="invalid-feedback">Informe o usu치rio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="senha" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="senha" required>
                        <div class="invalid-feedback">Informe a senha.</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmaSenha" class="form-label">Confirmar Senha</label>
                        <input type="password" class="form-control" id="confirmaSenha" required>
                        <div class="invalid-feedback">As senhas n칚o conferem.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Cadastrar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Abrir modal ao clicar no bot칚o
    document.getElementById('btn-cadastrar-usuario').addEventListener('click', function (e) {
        e.preventDefault();
        var myModal = new bootstrap.Modal(document.getElementById('modalCadastrarUsuario'));
        myModal.show();

        // Aplica m치scara IMask no campo CPF
        var cpfElement = document.getElementById('cpf');
        var cpfMask = IMask(cpfElement, {
            mask: '000.000.000-00'
        });
    });

    // Valida칞칚o CPF simples (exemplo)
    function validarCPF(cpf) {
        cpf = cpf.replace(/[^\d]+/g, '');
        if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
        // c치lculo simplificado, posso detalhar se quiser
        var sum = 0, rest;
        for (var i = 1; i <= 9; i++) sum += parseInt(cpf.substring(i - 1, i)) * (11 - i);
        rest = (sum * 10) % 11;
        if ((rest === 10) || (rest === 11)) rest = 0;
        if (rest !== parseInt(cpf.substring(9, 10))) return false;
        sum = 0;
        for (i = 1; i <= 10; i++) sum += parseInt(cpf.substring(i - 1, i)) * (12 - i);
        rest = (sum * 10) % 11;
        if ((rest === 10) || (rest === 11)) rest = 0;
        if (rest !== parseInt(cpf.substring(10, 11))) return false;
        return true;
    }

    document.getElementById('formCadastrarUsuario').addEventListener('submit', function (e) {
        e.preventDefault();
        var cpfInput = document.getElementById('cpf');
        var userInput = document.getElementById('username');
        var senhaInput = document.getElementById('senha');
        var confirmaInput = document.getElementById('confirmaSenha');

        var valid = true;

        // Valida칞칚o dos campos
        if (!validarCPF(cpfInput.value)) {
            cpfInput.classList.add('is-invalid');
            valid = false;
        } else {
            cpfInput.classList.remove('is-invalid');
        }

        if (!userInput.value.trim()) {
            userInput.classList.add('is-invalid');
            valid = false;
        } else {
            userInput.classList.remove('is-invalid');
        }

        if (!senhaInput.value.trim()) {
            senhaInput.classList.add('is-invalid');
            valid = false;
        } else {
            senhaInput.classList.remove('is-invalid');
        }

        if (confirmaInput.value !== senhaInput.value || !confirmaInput.value.trim()) {
            confirmaInput.classList.add('is-invalid');
            valid = false;
        } else {
            confirmaInput.classList.remove('is-invalid');
        }

        // 游댷 Envia os dados para o backend se tudo estiver v치lido
        if (valid) {
            fetch('/cadastrar-usuario/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // S칩 funciona se o CSRF estiver no cookie
                },
                body: JSON.stringify({
                    cpf: cpfInput.value,
                    username: userInput.value,
                    senha: senhaInput.value
                })
            })
                .then(response => response.json())
                .then(data => {
                    // Limpa erros anteriores
                    cpfInput.classList.remove('is-invalid');
                    userInput.classList.remove('is-invalid');
                    senhaInput.classList.remove('is-invalid');
                    confirmaInput.classList.remove('is-invalid');

                    // Reseta mensagens padr칫es
                    cpfInput.nextElementSibling.textContent = 'CPF inv치lido.';
                    userInput.nextElementSibling.textContent = 'Informe o usu치rio.';
                    senhaInput.nextElementSibling.textContent = 'Informe a senha.';
                    confirmaInput.nextElementSibling.textContent = 'As senhas n칚o conferem.';

                    if (data.errors) {
                        if (data.errors.cpf) {
                            cpfInput.classList.add('is-invalid');
                            cpfInput.nextElementSibling.textContent = data.errors.cpf;
                        }
                        if (data.errors.username) {
                            userInput.classList.add('is-invalid');
                            userInput.nextElementSibling.textContent = data.errors.username;
                        }
                        if (data.errors.senha) {
                            senhaInput.classList.add('is-invalid');
                            senhaInput.nextElementSibling.textContent = data.errors.senha;
                        }
                        if (data.errors.confirmaSenha) {
                            confirmaInput.classList.add('is-invalid');
                            confirmaInput.nextElementSibling.textContent = data.errors.confirmaSenha;
                        }
                    } else if (data.error) {
                        alert('Erro: ' + data.error);
                    } else {
                        alert(data.message);
                        // Fecha o modal
                        var myModalEl = document.getElementById('modalCadastrarUsuario');
                        var modal = bootstrap.Modal.getInstance(myModalEl);
                        modal.hide();

                        // Limpa o formul치rio
                        document.getElementById('formCadastrarUsuario').reset();
                    }
                })
        }
    });

    // 游꼵 Fun칞칚o auxiliar para pegar o CSRF token do cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('modalCadastrarUsuario').addEventListener('hidden.bs.modal', function () {
        const form = document.getElementById('formCadastrarUsuario');
        form.reset();

        // Limpa estados de erro
        const inputs = form.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.classList.remove('is-invalid');
        });

        // Restaura mensagens padr칚o
        document.getElementById('cpf').nextElementSibling.textContent = 'CPF inv치lido.';
        document.getElementById('username').nextElementSibling.textContent = 'Informe o usu치rio.';
        document.getElementById('senha').nextElementSibling.textContent = 'Informe a senha.';
        document.getElementById('confirmaSenha').nextElementSibling.textContent = 'As senhas n칚o conferem.';
    });
</script>

{% if messages %}
{% for message in messages %}
{% if 'cadastro' in message.tags %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const successModalEl = document.getElementById('cadastroSucessoModal');
        if (successModalEl) {
            const successModal = new bootstrap.Modal(successModalEl);
            successModal.show();

            // Fecha automaticamente ap칩s 3 segundos
            setTimeout(() => successModal.hide(), 3000);
        }
    });
</script>
{% endif %}
{% endfor %}
{% endif %}

<!-- Script para alternar Create/Update -->
<script>
    // Modo Create
    function setCreateMode() {
        document.getElementById("funcionarioModalLabel").innerText = "Cadastrar Funcion치rio";
        document.getElementById("funcionarioForm").action = "{% url 'create' %}";

        document.getElementById('id_matricula').value = '';
        document.getElementById('id_data_nascimento').value = '';
        document.getElementById('id_nome').value = '';
        document.getElementById('id_cpf').value = '';
        document.getElementById('id_funcao').value = '';
        document.getElementById('id_status').value = '';
        document.getElementById('id_obra').value = '';
        document.getElementById('id_nivel_funcao').value = '';
        document.getElementById('id_data_admissao').value = '';

        // Endere칞o
        document.getElementById('id_cep').value = '';
        document.getElementById('id_logradouro').value = '';
        document.getElementById('id_bairro').value = '';
        document.getElementById('id_cidade').value = '';
        document.getElementById('id_uf').value = '';
        document.getElementById('id_numero').value = '';
        document.getElementById('id_complemento').value = '';

        document.getElementById('id_matricula').readOnly = false;

        // Remove a classe 'is-invalid' dos inputs
        document.querySelectorAll('#funcionarioForm .is-invalid').forEach(function (el) {
            el.classList.remove('is-invalid');
        });

        // Esconde as mensagens de erro
        document.querySelectorAll('#funcionarioForm .invalid-feedback').forEach(function (el) {
            el.style.display = 'none';
            el.classList.remove('d-block');
        });

        // Campos e 칤cones
        const fileFields = [
            { id: 'id_foto', previewReset: true },
            { id: 'id_ordem_servico', iconId: 'icon-ordem-servico' },
            { id: 'id_contrato_trabalho', iconId: 'icon-contrato-trabalho' }
        ];

        fileFields.forEach(field => {
            const oldInput = document.getElementById(field.id);
            if (oldInput) {
                const newInput = oldInput.cloneNode(true);
                oldInput.parentNode.replaceChild(newInput, oldInput);

                if (field.previewReset) {
                    // Reset preview da foto
                    const preview = document.getElementById('preview-foto');
                    if (preview) {
                        preview.src = '';
                        preview.style.display = 'none';
                    }
                }

                if (field.iconId) {
                    const icon = document.getElementById(field.iconId);
                    if (icon) {
                        icon.src = "{% static 'img/box_aberto.png' %}";
                        icon.alt = "Ba칰 aberto";
                        icon.classList.remove('icon-animate');
                    }
                }
            }
        });

        // Reaplicar event listeners nos inputs clonados
        setupFotoPreview();
        setupIconAnimation('id_ordem_servico', 'icon-ordem-servico');
        setupIconAnimation('id_contrato_trabalho', 'icon-contrato-trabalho');
    }

    function formatCPF(cpf) {
        cpf = cpf.replace(/\D/g, ''); // s칩 n칰meros
        if (cpf.length !== 11) return cpf; // se n칚o for 11 d칤gitos, retorna sem formata칞칚o
        return cpf.substring(0, 3) + '.' + cpf.substring(3, 6) + '.' + cpf.substring(6, 9) + '-' + cpf.substring(9, 11);
    }

    function setUpdateMode(matricula, data_nascimento, nome, cpf, funcao, nivel_funcao, status, obra, data_admissao, cep, logradouro, bairro, cidade, uf, numero, complemento, fotoUrl, ordemServicoExiste, contratoTrabalhoExiste) {
        function cleanValue(value) {
            if (!value || value === "None") {
                return '';
            }
            return value;
        }

        document.getElementById("funcionarioModalLabel").innerText = "Editar Funcion치rio";
        document.getElementById("funcionarioForm").action = "/update/" + matricula + "/";
        document.getElementById('id_data_nascimento').value = data_nascimento;

        // Preenche campos
        document.getElementById('id_matricula').value = matricula;
        document.getElementById('id_nome').value = nome;
        document.getElementById('id_cpf').value = formatCPF(cpf);
        document.getElementById('id_funcao').value = funcao;
        document.getElementById('id_status').value = status;
        document.getElementById('id_obra').value = obra;
        document.getElementById('id_nivel_funcao').value = nivel_funcao;
        document.getElementById('id_data_admissao').value = data_admissao;

        // Endere칞o
        document.getElementById('id_cep').value = cleanValue(cep);
        document.getElementById('id_logradouro').value = cleanValue(logradouro);
        document.getElementById('id_bairro').value = cleanValue(bairro);
        document.getElementById('id_cidade').value = cleanValue(cidade);
        document.getElementById('id_uf').value = cleanValue(uf);
        document.getElementById('id_numero').value = cleanValue(numero);
        document.getElementById('id_complemento').value = cleanValue(complemento);

        document.getElementById('id_matricula').readOnly = true;

        // Mostrar preview da foto
        const preview = document.getElementById('preview-foto');
        if (fotoUrl && fotoUrl.trim() !== '') {
            preview.src = fotoUrl;
            preview.style.display = 'inline-block';
        } else {
            preview.src = '';
            preview.style.display = 'none';
        }

        // Reset inputs file (n칚o pode setar valor, ent칚o clone)
        ['id_foto', 'id_ordem_servico', 'id_contrato_trabalho'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
            }
        });

        // Atualizar 칤cones dos anexos
        const iconOrdem = document.getElementById('icon-ordem-servico');
        if (ordemServicoExiste) {
            iconOrdem.src = "{% static 'img/box_fechado.png' %}";
            iconOrdem.alt = "Ba칰 fechado";
        } else {
            iconOrdem.src = "{% static 'img/box_aberto.png' %}";
            iconOrdem.alt = "Ba칰 aberto";
        }
        iconOrdem.classList.remove('icon-animate');

        const iconContrato = document.getElementById('icon-contrato-trabalho');
        if (contratoTrabalhoExiste) {
            iconContrato.src = "{% static 'img/box_fechado.png' %}";
            iconContrato.alt = "Ba칰 fechado";
        } else {
            iconContrato.src = "{% static 'img/box_aberto.png' %}";
            iconContrato.alt = "Ba칰 aberto";
        }
        iconContrato.classList.remove('icon-animate');

        // Reaplicar event listeners nos inputs clonados
        setupFotoPreview();
        setupIconAnimation('id_ordem_servico', 'icon-ordem-servico');
        setupIconAnimation('id_contrato_trabalho', 'icon-contrato-trabalho');
    }


    function handleEditClick(button) {
        const data = button.dataset;

        console.log("DATA ADMISS츾O:", data.dataAdmissao);

        setUpdateMode(
            data.matricula,
            data.dataNascimento,
            data.nome,
            data.cpf,
            data.funcao,
            data.nivel_funcao,
            data.status,
            data.obra,
            data.data_admissao,
            data.cep,
            data.logradouro,
            data.bairro,
            data.cidade,
            data.uf,
            data.numero,
            data.complemento,
            data.fotoUrl,
            data.ordemServicoExiste === 'true',
            data.contratoTrabalhoExiste === 'true'
        );
    }

</script>

{% if form.errors %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modalElement = document.getElementById('funcionarioModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    });
</script>
{% endif %}

<!-- barra de pesquisa -->
<script>
    document.getElementById('searchInput').addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('table tbody tr');

        rows.forEach(row => {
            const matricula = row.cells[0].textContent.toLowerCase();
            const nome = row.cells[1].textContent.toLowerCase();
            const funcao = row.cells[2].textContent.toLowerCase();
            const status = row.cells[3].textContent.toLowerCase();
            const obra = row.cells[4].textContent.toLowerCase();

            if (
                matricula.includes(filter) ||
                nome.includes(filter) ||
                funcao.includes(filter) ||
                status.includes(filter) ||
                obra.includes(filter)
            ) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
</script>

<!-- M치scara para o campo CPF -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cpfInput = document.getElementById('id_cpf');

        if (cpfInput) {
            IMask(cpfInput, {
                mask: '000.000.000-00'
            });
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cpfElements = document.querySelectorAll('[data-format-cpf]');

        cpfElements.forEach(el => {
            let rawCpf = el.textContent.replace(/\D/g, '');
            if (rawCpf.length === 11) {
                el.textContent = rawCpf.slice(0, 3) + '.' +
                    rawCpf.slice(3, 6) + '.' +
                    rawCpf.slice(6, 9) + '-' +
                    rawCpf.slice(9);
            }
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('funcionarioForm');
        const cepInput = document.getElementById('id_cep');
        const cepError = document.getElementById('cep-error');

        if (cepInput) {
            IMask(cepInput, {
                mask: '00000-000'
            });
        }

        // Armazenar o estado de validade do CEP
        let cepValido = true;

        form.addEventListener('submit', function (event) {
            const rawCep = cepInput.value.replace(/\D/g, '');

            if (rawCep.length !== 8 || cepInput.classList.contains('is-invalid')) {
                // Impede envio
                event.preventDefault();
                event.stopPropagation();

                // Adiciona estilo de erro se n칚o tiver
                cepInput.classList.add('is-invalid');
                cepError.style.display = 'block';
                cepValido = false;
            }
        });

        // Valida칞칚o ao digitar
        cepInput.addEventListener('input', function () {
            const rawCep = cepInput.value.replace(/\D/g, '');

            if (rawCep.length === 8) {
                fetch(`https://viacep.com.br/ws/${rawCep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            // CEP v치lido
                            cepInput.classList.remove('is-invalid');
                            cepError.style.display = 'none';
                            cepValido = true;

                            // Preenche os campos
                            document.getElementById('id_logradouro').value = data.logradouro || '';
                            document.getElementById('id_bairro').value = data.bairro || '';
                            document.getElementById('id_cidade').value = data.localidade || '';
                            document.getElementById('id_uf').value = data.uf || '';
                        } else {
                            mostrarErro();
                        }
                    })
                    .catch(() => {
                        mostrarErro();
                    });
            } else {
                // Ainda n칚o h치 8 d칤gitos - apenas limpa erros visuais
                cepInput.classList.remove('is-invalid');
                cepError.style.display = 'none';
            }
        });

        function mostrarErro() {
            cepInput.classList.add('is-invalid');
            cepError.style.display = 'block';
            cepValido = false;

            // Limpa os campos
            document.getElementById('id_logradouro').value = '';
            document.getElementById('id_bairro').value = '';
            document.getElementById('id_cidade').value = '';
            document.getElementById('id_uf').value = '';
        }
    });

    // anexo
    function setupIconAnimation(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);

        if (input && icon) {
            input.addEventListener('change', function () {
                if (input.files.length > 0) {
                    icon.src = "{% static 'img/box_fechado.png' %}";
                    icon.alt = "Ba칰 fechado";
                } else {
                    icon.src = "{% static 'img/box_aberto.png' %}";
                    icon.alt = "Ba칰 aberto";
                }

                icon.classList.remove('icon-animate'); // Reinicia se j치 tiver
                void icon.offsetWidth; // For칞a reflow
                icon.classList.add('icon-animate');
            });
        }
    }

    function setupFotoPreview() {
        const inputFoto = document.getElementById('id_foto');
        const preview = document.getElementById('preview-foto');

        if (inputFoto && preview) {
            inputFoto.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        preview.src = e.target.result;
                        preview.style.display = 'inline-block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.src = '';
                    preview.style.display = 'none';
                }
            });
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const previewFoto = document.getElementById('preview-foto');
        if (previewFoto && previewFoto.src && !previewFoto.src.includes('base64') && previewFoto.src.trim() !== '') {
            previewFoto.style.display = 'inline-block';
        }
    });

</script>

<script>
    document.getElementById('print-pdf').addEventListener('click', function (e) {
        e.preventDefault();
        window.print();
    });
</script>

<script src="https://unpkg.com/imask"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}