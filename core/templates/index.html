{% extends 'base.html' %}

{% block title %}Lista de Funcionários{% endblock %}

{% block content %}

{% load static %}

<div class="container mt-3">
    <div class="container mt-3">
        <div class="row mb-3 align-items-center">
            <!-- Campo de busca com largura md-4 -->
            <div class="col-md-4">
                <input id="searchInput" type="search" class="form-control" placeholder="Pesquisar funcionário...">
            </div>

            <!-- Espaço flexível para empurrar o botão à direita -->
            <div class="col-md-8 text-end">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#funcionarioModal"
                    onclick="setCreateMode()"><i class="bi bi-person-plus"></i> Novo funcionário
                </button>
            </div>
        </div>

        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Matrícula</th>
                    <th scope="col">Nome</th>
                    <th scope="col">Função</th>
                    <th scope="col">Status</th>
                    <th scope="col">Obra</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for funcionario in funcionarios %}
                <tr>
                    <td>{{ funcionario.matricula }}</td>
                    <td>{{ funcionario.nome }}</td>
                    <td>{{ funcionario.funcao }}</td>
                    <td>{{ funcionario.get_status_display }}</td>
                    <td>{{ funcionario.obra }}</td>
                    <td class="text-center">
                        <!-- Visualizar -->
                        <button type="button" class="btn btn-sm btn-info text-white" style="background-color: #78b7ff;"
                            data-bs-toggle="modal" data-bs-target="#viewModal{{ funcionario.matricula }}">
                            <i class="bi bi-eye text-muted"></i>
                        </button>

                        <!-- Editar -->
                        <button class="btn btn-warning text-white" data-bs-toggle="modal"
                            data-bs-target="#funcionarioModal" data-matricula="{{ funcionario.matricula }}"
                            data-nome="{{ funcionario.nome }}" data-funcao="{{ funcionario.funcao }}"
                            data-nivel_funcao="{{ funcionario.nivel_funcao }}" data-status="{{ funcionario.status }}"
                            data-obra="{{ funcionario.obra }}" data-cpf="{{ funcionario.cpf }}"
                            data-data_admissao="{{ funcionario.data_admissao|date:'Y-m-d' }}"
                            data-cep="{{ funcionario.cep }}" data-logradouro="{{ funcionario.logradouro }}"
                            data-bairro="{{ funcionario.bairro }}" data-cidade="{{ funcionario.cidade }}"
                            data-uf="{{ funcionario.uf }}" onclick="handleEditClick(this)">
                            <i class="bi bi-pencil text-muted"></i>
                        </button>

                        <!-- Deletar -->
                        <button type="button" class="btn btn-sm btn-danger text-white"
                            style="background-color: #ff5555;" data-bs-toggle="modal"
                            data-bs-target="#deleteModal{{ funcionario.matricula }}">
                            <i class="bi bi-trash text-muted"></i>
                        </button>
                    </td>

                    <!-- Modal de Visualizar -->
                    <div class="modal fade" id="viewModal{{ funcionario.matricula }}" tabindex="-1"
                        aria-labelledby="viewModalLabel{{ funcionario.matricula }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title" id="viewModalLabel{{ funcionario.matricula }}">
                                        Detalhes do Funcionário
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white"
                                        data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body"
                                    style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;">
                                    <!-- Informações do funcionário -->
                                    <div style="flex: 1; min-width: 200px; margin-top: 10px;">
                                        <p><strong>Matrícula:</strong> {{ funcionario.matricula|default:"Não
                                            informado"}}</p>
                                        <p><strong>Nome:</strong> {{ funcionario.nome|default:"Não informado" }}</p>
                                        <p><strong>Função:</strong> {{ funcionario.funcao|default:"Não informado" }}</p>
                                        <p><strong>Nível da função:</strong> {{ funcionario.nivel_funcao|default:"Não
                                            informado" }}</p>
                                        <p><strong>Status:</strong> {{ funcionario.get_status_display|default:"Não
                                            informado" }}</p>
                                        <p><strong>Obra:</strong> {{ funcionario.obra|default:"Não informado" }}</p>

                                        <p><strong>CPF:</strong>
                                            {% if funcionario.cpf %}
                                            <span data-format-cpf>{{ funcionario.cpf }}</span>
                                            {% else %}
                                            Não informado
                                            {% endif %}
                                        </p>

                                        {% if funcionario.data_admissao %}
                                        <p><strong>Data de Admissão:</strong> {{
                                            funcionario.data_admissao|date:"d/m/Y"}}</p>
                                        {% else %}
                                        <p><strong>Data de Admissão:</strong> Não informada</p>
                                        {% endif %}

                                        <p><strong>CEP:</strong> {{ funcionario.cep|default:"Não informado" }}</p>
                                        <p><strong>Logradouro:</strong> {{ funcionario.logradouro|default:"Não
                                            informado" }}</p>
                                        <p><strong>Bairro:</strong> {{ funcionario.bairro|default:"Não informado" }}</p>
                                        <p><strong>Cidade:</strong> {{ funcionario.cidade|default:"Não informado" }}</p>
                                        <p><strong>UF:</strong> {{ funcionario.uf|default:"Não informado" }}</p>
                                    </div>


                                    <!-- Foto do funcionário com ajuste -->
                                    <div style="flex: 0 0 150px; margin-right: 30px; margin-top: 10px;">
                                        {% if funcionario.foto %}
                                        <img src="{{ funcionario.foto.url }}" alt="Foto de {{ funcionario.nome }}"
                                            class="img-fluid rounded"
                                            style="width: 150px; height: 200px; object-fit: cover;">
                                        {% else %}
                                        <img src="{% static 'img/sem-foto.png' %}" alt="Sem foto"
                                            class="img-fluid rounded"
                                            style="width: 150px; height: 200px; object-fit: cover;">
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal de Deleção (dentro do for) -->
                    <div class="modal fade" id="deleteModal{{ funcionario.matricula }}" tabindex="-1"
                        aria-labelledby="deleteModalLabel{{ funcionario.matricula }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title" id="deleteModalLabel{{ funcionario.matricula }}">Confirmar
                                        Exclusão</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Fechar"></button>
                                </div>
                                <div class="modal-body">
                                    Tem certeza que deseja excluir o funcionário <strong>{{ funcionario.nome}}</strong>?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancelar</button>
                                    <a href="{% url 'delete' funcionario.matricula %}"
                                        class="btn btn-danger">Excluir</a>
                                </div>
                            </div>
                        </div>
                    </div>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">Nenhum funcionário cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <form method="post" id="funcionarioForm" enctype="multipart/form-data" autocomplete="off">
        <div class="modal fade" id="funcionarioModal" tabindex="-1" aria-labelledby="funcionarioModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" id="funcionarioForm">
                        {% csrf_token %}
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="funcionarioModalLabel">Cadastrar Funcionário</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">

                            <div class="mb-3">
                                <label for="id_matricula" class="form-label">Matrícula</label>
                                {{ form.matricula }}
                                {% if form.matricula.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.matricula.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="id_nome" class="form-label">Nome</label>
                                {{ form.nome }}
                            </div>

                            <div class="mb-3">
                                <label for="id_funcao" class="form-label">Função</label>
                                {{ form.funcao }}
                            </div>

                            <div class="mb-3">
                                <label for="id_nivel_funcao" class="form-label">Nível da Função</label>
                                {{ form.nivel_funcao }}
                            </div>

                            <div class="mb-3">
                                <label for="id_status" class="form-label">Status</label>
                                {{ form.status }}
                            </div>

                            <div class="mb-3">
                                <label for="id_obra" class="form-label">Obra</label>
                                {{ form.obra }}
                            </div>

                            <div class="mb-3">
                                <label for="id_foto" class="form-label">Foto</label>
                                {{ form.foto }}
                            </div>

                            <div class="mb-3">
                                <label for="id_cpf" class="form-label">CPF</label>
                                {{ form.cpf }}
                                {% if form.cpf.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.cpf.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="id_data_admissao" class="form-label">Data de Admissão</label>
                                {% if form.data_admissao.errors %}
                                {{ form.data_admissao }}
                                <div class="invalid-feedback d-block">
                                    {{ form.data_admissao.errors.0 }}
                                </div>
                                {% else %}
                                {{ form.data_admissao }}
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_cep" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="id_cep" name="cep" maxlength="9" required>
                                <div class="invalid-feedback" id="cep-error" style="display: none;">CEP inválido ou não
                                    encontrado.</div>
                            </div>

                            <div class="mb-3">
                                <label for="id_logradouro" class="form-label">Logradouro</label>
                                <input type="text" class="form-control" id="id_logradouro" name="logradouro">
                            </div>

                            <div class="mb-3">
                                <label for="id_bairro" class="form-label">Bairro</label>
                                <input type="text" class="form-control" id="id_bairro" name="bairro">
                            </div>

                            <div class="mb-3">
                                <label for="id_cidade" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="id_cidade" name="cidade">
                            </div>

                            <div class="mb-3">
                                <label for="id_uf" class="form-label">Estado (UF)</label>
                                <input type="text" class="form-control" id="id_uf" name="uf">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </form>

    <!-- Modal de Sucesso -->
    <div class="modal fade" id="cadastroSucessoModal" tabindex="-1" aria-labelledby="cadastroSucessoLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-success text-center">
                <div class="modal-header bg-success text-white py-2 d-flex justify-content-center position-relative">
                    <h6 class="modal-title w-100" id="cadastroSucessoLabel">Sucesso!</h6>
                    <button type="button" class="btn-close btn-close-white position-absolute end-0 me-2"
                        data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    Funcionário cadastrado com sucesso!
                </div>
            </div>
        </div>

        {% if messages %}
        {% for message in messages %}
        {% if 'cadastro' in message.tags %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const successModalEl = document.getElementById('cadastroSucessoModal');
                if (successModalEl) {
                    const successModal = new bootstrap.Modal(successModalEl);
                    successModal.show();

                    // Fecha automaticamente após 3 segundos
                    setTimeout(() => successModal.hide(), 3000);
                }
            });
        </script>
        {% endif %}
        {% endfor %}
        {% endif %}

        <!-- Script para alternar Create/Update -->
        <script>
            // Modo Create
            function setCreateMode() {
                document.getElementById("funcionarioModalLabel").innerText = "Cadastrar Funcionário";
                document.getElementById("funcionarioForm").action = "{% url 'create' %}";

                document.getElementById('id_matricula').value = '';
                document.getElementById('id_nome').value = '';
                document.getElementById('id_funcao').value = '';
                document.getElementById('id_status').value = '';
                document.getElementById('id_obra').value = '';
                document.getElementById('id_cpf').value = '';  // <-- Corrigido aqui
                document.getElementById('id_nivel_funcao').value = '';
                document.getElementById('dataAdmissao').value = '';

                // Endereço
                document.getElementById('id_cep').value = '';
                document.getElementById('id_logradouro').value = '';
                document.getElementById('id_bairro').value = '';
                document.getElementById('id_cidade').value = '';
                document.getElementById('id_uf').value = '';

                document.getElementById('id_matricula').readOnly = false;

                // Remove a classe 'is-invalid' dos inputs
                document.querySelectorAll('#funcionarioForm .is-invalid').forEach(function (el) {
                    el.classList.remove('is-invalid');
                });

                // Esconde as mensagens de erro
                document.querySelectorAll('#funcionarioForm .invalid-feedback').forEach(function (el) {
                    el.style.display = 'none';
                    el.classList.remove('d-block');
                });
            }

            function formatCPF(cpf) {
                cpf = cpf.replace(/\D/g, ''); // só números
                if (cpf.length !== 11) return cpf; // se não for 11 dígitos, retorna sem formatação
                return cpf.substring(0, 3) + '.' + cpf.substring(3, 6) + '.' + cpf.substring(6, 9) + '-' + cpf.substring(9, 11);
            }

            function setUpdateMode(matricula, nome, funcao, nivel_funcao, status, obra, cpf, data_admissao, cep, logradouro, bairro, cidade, uf) {
                document.getElementById("funcionarioModalLabel").innerText = "Editar Funcionário";
                document.getElementById("funcionarioForm").action = "/update/" + matricula + "/";

                // Preenche campos
                document.getElementById('id_matricula').value = matricula;
                document.getElementById('id_nome').value = nome;
                document.getElementById('id_funcao').value = funcao;
                document.getElementById('id_status').value = status;
                document.getElementById('id_obra').value = obra;
                document.getElementById('id_cpf').value = formatCPF(cpf);
                document.getElementById('id_nivel_funcao').value = nivel_funcao;
                document.getElementById('dataAdmissao').value = data_admissao;

                // Endereço
                document.getElementById('id_cep').value = cep || '';
                document.getElementById('id_logradouro').value = logradouro || '';
                document.getElementById('id_bairro').value = bairro || '';
                document.getElementById('id_cidade').value = cidade || '';
                document.getElementById('id_uf').value = uf || '';

                document.getElementById('id_matricula').readOnly = true;
            }

            function handleEditClick(button) {
                const data = button.dataset;

                setUpdateMode(
                    data.matricula,
                    data.nome,
                    data.funcao,
                    data.nivel_funcao,
                    data.status,
                    data.obra,
                    data.cpf,
                    data.data_admissao,
                    data.cep,
                    data.logradouro,
                    data.bairro,
                    data.cidade,
                    data.uf
                );
            }

        </script>

        {% if form.errors %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const modalElement = document.getElementById('funcionarioModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            });
        </script>
        {% endif %}

        <!-- barra de pesquisa -->
        <script>
            document.getElementById('searchInput').addEventListener('input', function () {
                const filter = this.value.toLowerCase();
                const rows = document.querySelectorAll('table tbody tr');

                rows.forEach(row => {
                    const matricula = row.cells[0].textContent.toLowerCase();
                    const nome = row.cells[1].textContent.toLowerCase();
                    const funcao = row.cells[2].textContent.toLowerCase();
                    const status = row.cells[3].textContent.toLowerCase();
                    const obra = row.cells[4].textContent.toLowerCase();

                    if (
                        matricula.includes(filter) ||
                        nome.includes(filter) ||
                        funcao.includes(filter) ||
                        status.includes(filter) ||
                        obra.includes(filter)
                    ) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        </script>

        <!-- Máscara para o campo CPF -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const cpfInput = document.getElementById('id_cpf');

                if (cpfInput) {
                    IMask(cpfInput, {
                        mask: '000.000.000-00'
                    });
                }
            });
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const cpfElements = document.querySelectorAll('[data-format-cpf]');

                cpfElements.forEach(el => {
                    let rawCpf = el.textContent.replace(/\D/g, '');
                    if (rawCpf.length === 11) {
                        el.textContent = rawCpf.slice(0, 3) + '.' +
                            rawCpf.slice(3, 6) + '.' +
                            rawCpf.slice(6, 9) + '-' +
                            rawCpf.slice(9);
                    }
                });
            });
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const form = document.getElementById('funcionarioForm');
                const cepInput = document.getElementById('id_cep');
                const cepError = document.getElementById('cep-error');

                if (cepInput) {
                    IMask(cepInput, {
                        mask: '00000-000'
                    });
                }

                // Armazenar o estado de validade do CEP
                let cepValido = true;

                form.addEventListener('submit', function (event) {
                    const rawCep = cepInput.value.replace(/\D/g, '');

                    if (rawCep.length !== 8 || cepInput.classList.contains('is-invalid')) {
                        // Impede envio
                        event.preventDefault();
                        event.stopPropagation();

                        // Adiciona estilo de erro se não tiver
                        cepInput.classList.add('is-invalid');
                        cepError.style.display = 'block';
                        cepValido = false;
                    }
                });

                // Validação ao digitar
                cepInput.addEventListener('input', function () {
                    const rawCep = cepInput.value.replace(/\D/g, '');

                    if (rawCep.length === 8) {
                        fetch(`https://viacep.com.br/ws/${rawCep}/json/`)
                            .then(response => response.json())
                            .then(data => {
                                if (!data.erro) {
                                    // CEP válido
                                    cepInput.classList.remove('is-invalid');
                                    cepError.style.display = 'none';
                                    cepValido = true;

                                    // Preenche os campos
                                    document.getElementById('id_logradouro').value = data.logradouro || '';
                                    document.getElementById('id_bairro').value = data.bairro || '';
                                    document.getElementById('id_cidade').value = data.localidade || '';
                                    document.getElementById('id_uf').value = data.uf || '';
                                } else {
                                    mostrarErro();
                                }
                            })
                            .catch(() => {
                                mostrarErro();
                            });
                    } else {
                        // Ainda não há 8 dígitos - apenas limpa erros visuais
                        cepInput.classList.remove('is-invalid');
                        cepError.style.display = 'none';
                    }
                });

                function mostrarErro() {
                    cepInput.classList.add('is-invalid');
                    cepError.style.display = 'block';
                    cepValido = false;

                    // Limpa os campos
                    document.getElementById('id_logradouro').value = '';
                    document.getElementById('id_bairro').value = '';
                    document.getElementById('id_cidade').value = '';
                    document.getElementById('id_uf').value = '';
                }
            });
        </script>

        <script src="https://unpkg.com/imask"></script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        {% endblock %}